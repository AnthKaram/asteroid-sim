<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Asteroid and Moon Orbit Animation</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      
      #ui {
        position: fixed;
        top: 60px;
        left: 10px;
        width: 250px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 100;
      }
      
      #ui label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-size: 12px;
      }
      
      #ui input {
        width: 100%;
      }
      
      #ui-right {
        position: fixed;
        top: 60px;
        right: 10px;
        width: 250px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 100;
      }
      
      #ui-right label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-size: 12px;
      }
      
      #ui-right input {
        width: 100%;
      }
      
      .bottom-right {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
      }
      
      .bottom-right button {
        padding: 10px 15px;
        margin: 5px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      
      .reset-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
      }
      
      .reset-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        background: linear-gradient(45deg, #ff7979, #ff3838);
      }
      
      .gmat-launch-alert {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #4CAF50;
        text-align: center;
        z-index: 2000;
        box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        backdrop-filter: blur(10px);
      }
      
      .gmat-launch-alert h3 {
        color: #4CAF50;
        margin-bottom: 15px;
        font-size: 24px;
      }
      
      .gmat-launch-alert p {
        margin-bottom: 20px;
        font-size: 16px;
        line-height: 1.5;
      }
      
      .gmat-launch-alert button {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }
      
      .gmat-launch-alert button:hover {
        background: #45a049;
      }
      
      #navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        padding: 10px 0;
      }
      
      #navbar ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
      }
      
      #navbar li {
        margin: 0 15px;
      }
      
      #navbar a {
        color: white;
        text-decoration: none;
        font-weight: bold;
      }
      
      #stats {
        margin-top: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 5px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <nav id="navbar">
        <ul>
          <li>
            <a href="/">Customize Your Asteroid</a>
          </li>
          <li>
            <a href="/Preset.htm">Choose A Pre-Set</a>
          </li>
        </ul>
      </nav>
    </header>
    
    <div id="ui">
      <div style="font-weight: 600; margin-bottom: 8px">
        Asteroid Orbit Controls
      </div>

      <label>How far is the orbit?</label>
      <input id="a" type="range" min="7000" max="60000" step="100" value="12000" />

      <label>Is the orbit circle or stretched?</label>
      <input id="e" type="range" min="0" max="0.9" step="0.01" value="0.3" />

      <label>How tilted is the orbit?</label>
      <input id="inc" type="range" min="0" max="90" step="1" value="15" />

      <label>Orbit's turning direction</label>
      <input id="raan" type="range" min="0" max="360" step="1" value="40" />

      <label>Where's the closest point?</label>
      <input id="argp" type="range" min="0" max="360" step="1" value="20" />

      <label>Start position on orbit</label>
      <input id="M0" type="range" min="0" max="360" step="1" value="0" />

      <label>Mass of Asteroid (<span id="massDisplay">1.0√ó10‚Å∂</span> kg)</label>
      <input id="mass" type="range" min="3" max="9" step="0.1" value="6" oninput="updateMassDisplay(this.value)" />

      <label>Speed of Simulation (<span id="timeScaleDisplay">x1</span>)</label>
      <input id="timeScale" type="range" min="0.01" max="500" step="0.01" value="1" />

      <label>Kinetic Energy of Asteroid:</label>
      <div id="kinetic-energy">0 Joules</div>

      <label>Asteroid Velocity (km/s):</label>
      <input id="velocity" type="range" min="11" max="72" step="1" value="11" oninput="updateVelocity(this.value)" />
      <span id="velocity-value">11</span> km/s
    </div>
    
    <!-- New UI panel for GMAT controls on the right -->
    <div id="ui-right">
      <div style="font-weight: 600; margin-bottom: 8px">
        GMAT Integration Controls
      </div>
      
      <button id="toggleGMAT" style="width: 100%; margin-bottom: 10px; background: #f44336;">
        üî¥ GMAT OFF | Switch to GMAT Mode
      </button>
      
      <button id="startGMAT" style="width: 100%; margin-bottom: 10px;">
        Start GMAT Simulation
      </button>
      
      <button id="stopGMAT" style="width: 100%; margin-bottom: 10px;">
        Stop GMAT Simulation
      </button>
      
      <button id="launchGMAT" style="width: 100%; margin-bottom: 10px; background: #ff9800;">
        üöÄ Launch GMAT Rocket
      </button>
      
      <div id="gmat-status" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 12px;">
        Status: Manual Mode
      </div>
    </div>
    
    <div class="bottom-right">
      <button id="toggle">Pause</button>
      <button id="launch">Launch Rocket</button>
      <div id="stats"></div>
    </div>

    <!-- Reset Button (initially hidden) -->
    <button id="resetButton" class="reset-button" style="display: none;">Reset Simulation</button>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
      // Global variables for rocket launch tracking
      let gmatRocketLaunched = false;
      let gmatLaunchInProgress = false;

      document.addEventListener('DOMContentLoaded', () => {
          const timeScaleInput = document.getElementById('timeScale');
          const timeScaleDisplay = document.getElementById('timeScaleDisplay');
          const resetButton = document.getElementById('resetButton');

          timeScaleInput.addEventListener('input', () => {
            timeScaleDisplay.textContent = `x${timeScaleInput.value}`;
          });

          // Reset button functionality
          resetButton.addEventListener('click', () => {
            location.reload();
          });
        });

      function updateMassDisplay(value) {
        const massValue = Math.pow(10, parseFloat(value));
        const display = document.getElementById('massDisplay');
        if (massValue >= 1000000) {
          display.textContent = `${(massValue / 1000000).toFixed(1)}√ó10‚Å∂`;
        } else if (massValue >= 1000) {
          display.textContent = `${(massValue / 1000).toFixed(1)}√ó10¬≥`;
        } else {
          display.textContent = massValue.toFixed(0);
        }
      }

      function updateVelocity(value) {
        document.getElementById('velocity-value').textContent = value;
        const mass = Math.pow(10, parseFloat(document.getElementById('mass').value));
        const velocity = parseFloat(value) * 1000;
        const kineticEnergy = 0.5 * mass * velocity * velocity;
        document.getElementById('kinetic-energy').textContent = `${kineticEnergy.toExponential(2)} Joules`;
      }

      // Function to show GMAT launch alert
      function showGMATLaunchAlert() {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'gmat-launch-alert';
        alertDiv.innerHTML = `
          <h3>üöÄ GMAT Rocket Launch Detected!</h3>
          <p>A rocket has been launched from GMAT and is intercepting the asteroid trajectory.</p>
          <p>The simulation will now show the deflection results from GMAT's high-precision orbital mechanics.</p>
          <button id="continueSim">OK</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        document.getElementById('continueSim').addEventListener('click', () => {
          // Refresh the page when OK is clicked
          location.reload();
        });
        
        // Show reset button
        document.getElementById('resetButton').style.display = 'block';
      }
    </script>

    <script>
      // Scene setup
      const scene = new THREE.Scene();
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const camera = new THREE.PerspectiveCamera(
        55,
        window.innerWidth / window.innerHeight,
        0.1,
        1e9
      );
      camera.position.set(0, 0, 35000);

      // Lights
      const light = new THREE.DirectionalLight(0xffffff, 1.0);
      light.position.set(1, 1, 0.5).multiplyScalar(1e6);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040, 0.8));

      // Earth placeholder
      const earthGeom = new THREE.SphereGeometry(6371, 64, 64);
      const earthTexture = new THREE.TextureLoader().load(
        "https://upload.wikimedia.org/wikipedia/commons/c/c3/Solarsystemscope_texture_2k_earth_daymap.jpg"
      );
      const earthMat = new THREE.MeshPhongMaterial({ map: earthTexture });
      const earth = new THREE.Mesh(earthGeom, earthMat);
      scene.add(earth);

      // Asteroid
      let asteroid = createAsteroid(1e6);
      scene.add(asteroid);

      function createRandomAsteroidGeometry() {
        const geometry = new THREE.IcosahedronGeometry(300, 1);
        const vertices = geometry.attributes.position.array;
        
        for (let i = 0; i < vertices.length; i += 3) {
          const displacement = 0.3 + Math.random() * 0.7;
          vertices[i] *= displacement;
          vertices[i + 1] *= displacement;
          vertices[i + 2] *= displacement;
        }
        
        geometry.computeVertexNormals();
        return geometry;
      }

      function createAsteroid(mass) {
        let asteroidGeom;
        
        if (mass < 1e6) {
          asteroidGeom = createRandomAsteroidGeometry();
        } else {
          asteroidGeom = new THREE.SphereGeometry(300, 24, 24);
        }
        
        const asteroidMat = new THREE.MeshPhongMaterial({
          color: 0xffa640,
          emissive: 0x352100,
        });
        return new THREE.Mesh(asteroidGeom, asteroidMat);
      }

      function updateAsteroidMass(mass) {
        scene.remove(asteroid);
        asteroid = createAsteroid(mass);
        scene.add(asteroid);
      }

      function deformAsteroid() {
        const geometry = asteroid.geometry.clone();
        const vertices = geometry.attributes.position.array;
        
        for (let i = 0; i < vertices.length; i += 3) {
          vertices[i] *= 1.5;
          vertices[i + 1] *= 0.8;
          vertices[i + 2] *= 1.2;
        }
        
        geometry.computeVertexNormals();
        asteroid.geometry.dispose();
        asteroid.geometry = geometry;
        asteroid.material.color.set(0x8B4513);
      }

      // Moon
      const moonRadius = 1737;
      const moonGeom = new THREE.SphereGeometry(moonRadius, 32, 32);
      const moonTexture = new THREE.TextureLoader().load(
        "https://upload.wikimedia.org/wikipedia/commons/2/26/Solarsystemscope_texture_2k_moon.jpg"
      );
      const moonMat = new THREE.MeshPhongMaterial({ map: moonTexture });
      const moon = new THREE.Mesh(moonGeom, moonMat);
      scene.add(moon);

      // Orbit path line for asteroid
      const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x8fd3ff });
      let orbitLine = new THREE.Line(new THREE.BufferGeometry(), orbitMaterial);
      scene.add(orbitLine);

      // UI elements
      const ui = ["a", "e", "inc", "raan", "argp", "M0", "timeScale", "mass", "velocity"].reduce(
        (o, id) => ({ ...o, [id]: document.getElementById(id) }),
        {}
      );
      const stats = document.getElementById("stats");
      const toggleBtn = document.getElementById("toggle");
      const launchBtn = document.getElementById("launch");

      // GMAT UI elements
      const toggleGMATBtn = document.getElementById("toggleGMAT");
      const startGMATBtn = document.getElementById("startGMAT");
      const stopGMATBtn = document.getElementById("stopGMAT");
      const launchGMATBtn = document.getElementById("launchGMAT");
      const gmatStatus = document.getElementById("gmat-status");

      // Constants
      const muEarth = 3.986004418e5;
      const muMoonOrbit = muEarth;

      const d2r = (d) => (d * Math.PI) / 180;

      function solveKepler(M, e) {
        let E = e < 0.8 ? M : Math.PI;
        for (let k = 0; k < 20; k++) {
          const f = E - e * Math.sin(E) - M;
          const fp = 1 - e * Math.cos(E);
          E = E - f / fp;
        }
        return E;
      }

      function rotatePerifocalToECI(vecPF, i, Omega, omega) {
        const ci = Math.cos(i), si = Math.sin(i);
        const cO = Math.cos(Omega), sO = Math.sin(Omega);
        const co = Math.cos(omega), so = Math.sin(omega);

        const R = [
          cO * co - sO * so * ci, -cO * so - sO * co * ci, sO * si,
          sO * co + cO * so * ci, -sO * so + cO * co * ci, -cO * si,
          so * si, co * si, ci,
        ];
        return new THREE.Vector3(
          R[0] * vecPF.x + R[1] * vecPF.y + R[2] * vecPF.z,
          R[3] * vecPF.x + R[4] * vecPF.y + R[5] * vecPF.z,
          R[6] * vecPF.x + R[7] * vecPF.y + R[8] * vecPF.z
        );
      }

      function buildOrbitGeometry(a, e, i, Omega, omega) {
        const points = [];
        const steps = 512;
        for (let s = 0; s <= steps; s++) {
          const M = 2 * Math.PI * (s / steps);
          const E = solveKepler(M, e);
          const x_pf = a * (Math.cos(E) - e);
          const y_pf = a * (Math.sqrt(1 - e * e) * Math.sin(E));
          const r_pf = new THREE.Vector3(x_pf, y_pf, 0);
          const r_eci = rotatePerifocalToECI(r_pf, i, Omega, omega);
          points.push(r_eci);
        }
        const geom = new THREE.BufferGeometry().setFromPoints(points);
        return geom;
      }

      // Enhanced GMAT Integration with Rocket Launch Support
      class PhysicsGMATIntegration {
        constructor() {
          this.isConnected = false;
          this.simulationActive = false;
          this.currentData = null;
          this.pollInterval = null;
          this.baseURL = '/gmat';
          this.manualMode = true;
          this.rocketLaunched = false;
          this.deflectionOccurred = false;
        }

        init() {
          this.setupEventListeners();
          this.updateControlButtons();
          this.updatePhysicsStatus('Manual Mode');
        }

        setupEventListeners() {
          toggleGMATBtn.addEventListener('click', () => {
            this.toggleGMATIntegration();
          });

          startGMATBtn.addEventListener('click', () => {
            this.startGMATSimulation();
          });

          stopGMATBtn.addEventListener('click', () => {
            this.stopGMATSimulation();
          });

          launchGMATBtn.addEventListener('click', () => {
            this.launchGMATRocket();
          });
        }

        toggleGMATIntegration() {
          this.manualMode = !this.manualMode;
          
          if (this.manualMode) {
            this.updatePhysicsStatus('Manual Mode');
          } else {
            this.updatePhysicsStatus('GMAT Mode - Connecting...');
            this.fetchPhysicsData();
          }
          
          this.updateControlButtons();
        }

        startGMATSimulation() {
          this.simulationActive = true;
          this.updatePhysicsStatus('GMAT Simulation Running');
          this.updateControlButtons();
        }

        stopGMATSimulation() {
          this.simulationActive = false;
          this.updatePhysicsStatus('GMAT Simulation Stopped');
          this.updateControlButtons();
        }

        launchGMATRocket() {
          if (!this.rocketLaunched) {
            this.rocketLaunched = true;
            gmatRocketLaunched = true;
            this.updatePhysicsStatus('GMAT Rocket Launch Initiated');
            this.updateControlButtons();
            
            // Show the alert which will freeze the page
            showGMATLaunchAlert();
          }
        }

        updatePhysicsStatus(status) {
          gmatStatus.textContent = `Status: ${status}`;
        }

        updateControlButtons() {
          if (this.manualMode) {
            toggleGMATBtn.innerHTML = 'üî¥ GMAT OFF | Switch to GMAT Mode';
            toggleGMATBtn.style.background = '#f44336';
            startGMATBtn.disabled = true;
            stopGMATBtn.disabled = true;
            launchGMATBtn.disabled = true;
          } else {
            toggleGMATBtn.innerHTML = 'üü¢ GMAT ON | Switch to Manual Mode';
            toggleGMATBtn.style.background = '#4CAF50';
            startGMATBtn.disabled = this.simulationActive;
            stopGMATBtn.disabled = !this.simulationActive;
            launchGMATBtn.disabled = this.rocketLaunched;
          }
          
          if (this.rocketLaunched) {
            launchGMATBtn.innerHTML = 'üöÄ Rocket Launched';
            launchGMATBtn.style.background = '#9e9e9e';
          } else {
            launchGMATBtn.innerHTML = 'üöÄ Launch GMAT Rocket';
            launchGMATBtn.style.background = '#ff9800';
          }
        }

        fetchPhysicsData() {
          // This would normally fetch data from GMAT
          console.log('Fetching physics data from GMAT...');
        }
      }

      // Initialize the physics integration
      let physicsIntegration;

      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          physicsIntegration = new PhysicsGMATIntegration();
          physicsIntegration.init();
        }, 1000);
      });

      // Moon orbit parameters
      const moonOrbit = {
        a: 384400,
        e: 0.0549,
        i: d2r(5.145),
        Omega: 0,
        omega: 0,
        M0: 0,
      };

      function getElements() {
        const a = parseFloat(ui.a.value);
        const e = parseFloat(ui.e.value);
        const i = d2r(parseFloat(ui.inc.value));
        const Omega = d2r(parseFloat(ui.raan.value));
        const omega = d2r(parseFloat(ui.argp.value));
        const M0 = d2r(parseFloat(ui.M0.value));
        const mass = Math.pow(10, parseFloat(ui.mass.value));
        const timeScale = parseFloat(ui.timeScale.value);
        return { a, e, i, Omega, omega, M0, mass, timeScale };
      }

      function refreshOrbitLine() {
        const { a, e, i, Omega, omega } = getElements();
        orbitLine.geometry.dispose();
        orbitLine.geometry = buildOrbitGeometry(a, e, i, Omega, omega);
      }

      // Animation loop
      let paused = false;
      let time = 0;

      function animate() {
        if (!paused) {
          requestAnimationFrame(animate);
          
          const { a, e, i, Omega, omega, M0, mass, timeScale } = getElements();
          
          // Update asteroid position
          const M = M0 + time * timeScale * Math.sqrt(muEarth / (a * a * a));
          const E = solveKepler(M, e);
          const x_pf = a * (Math.cos(E) - e);
          const y_pf = a * (Math.sqrt(1 - e * e) * Math.sin(E));
          const r_pf = new THREE.Vector3(x_pf, y_pf, 0);
          const r_eci = rotatePerifocalToECI(r_pf, i, Omega, omega);
          asteroid.position.copy(r_eci);
          
          // Update moon position
          const M_moon = moonOrbit.M0 + time * Math.sqrt(muMoonOrbit / (moonOrbit.a * moonOrbit.a * moonOrbit.a));
          const E_moon = solveKepler(M_moon, moonOrbit.e);
          const x_moon_pf = moonOrbit.a * (Math.cos(E_moon) - moonOrbit.e);
          const y_moon_pf = moonOrbit.a * (Math.sqrt(1 - moonOrbit.e * moonOrbit.e) * Math.sin(E_moon));
          const r_moon_pf = new THREE.Vector3(x_moon_pf, y_moon_pf, 0);
          const r_moon_eci = rotatePerifocalToECI(r_moon_pf, moonOrbit.i, moonOrbit.Omega, moonOrbit.omega);
          moon.position.copy(r_moon_eci);
          
          time += 0.016; // ~60fps
        }
        
        renderer.render(scene, camera);
      }

      // Initialize animation
      animate();

      // Event listeners
      ['a', 'e', 'inc', 'raan', 'argp', 'M0'].forEach(id => {
        document.getElementById(id).addEventListener('input', refreshOrbitLine);
      });

      document.getElementById('mass').addEventListener('input', function() {
        updateMassDisplay(this.value);
        updateAsteroidMass(Math.pow(10, parseFloat(this.value)));
      });

      document.getElementById('velocity').addEventListener('input', function() {
        updateVelocity(this.value);
      });

      toggleBtn.addEventListener('click', function() {
        paused = !paused;
        this.textContent = paused ? 'Resume' : 'Pause';
        if (!paused) animate();
      });

      launchBtn.addEventListener('click', function() {
        // Simple rocket launch effect
        asteroid.material.color.set(0xff0000);
        setTimeout(() => {
          asteroid.material.color.set(0xffa640);
        }, 500);
      });

      // Initial setup
      refreshOrbitLine();
      updateMassDisplay(ui.mass.value);
      updateVelocity(ui.velocity.value);
    </script>
  </body>
</html>